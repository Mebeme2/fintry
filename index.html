<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Robot AR - Bed Mission</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  #confettiText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    color: black;
    font-weight: bold;
    display: none;
    pointer-events: none;
  }
  canvas { touch-action: none; }
</style>
</head>
<body>
<div id="confettiText">Mission Successful!</div>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.128/examples/jsm/webxr/ARButton.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128/examples/jsm/loaders/GLTFLoader.js';

let scene, camera, renderer;
let controller;
let robot, bed;
let placed = false;

init();
function init(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  document.body.appendChild(ARButton.createButton(renderer, {requiredFeatures:['hit-test']}));

  const light = new THREE.HemisphereLight(0xffffff,0xbbbbff,1);
  scene.add(light);

  // Controller for screen taps
  controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  // Load robot model
  const loader = new GLTFLoader();
  loader.load('robot.glb', function(gltf){
    robot = gltf.scene;
    robot.scale.set(0.5,0.5,0.5);
  });

  // Create simple bed
  const bedGeom = new THREE.BoxGeometry(0.8,0.3,1.2);
  const bedMat = new THREE.MeshStandardMaterial({color:0xff4444});
  bed = new THREE.Mesh(bedGeom, bedMat);

  renderer.setAnimationLoop(render);
}

function onSelect(){
  if(!placed){
    // Place robot at tap
    const tempMatrix = new THREE.Matrix4();
    tempMatrix.identity().extractRotation(controller.matrixWorld);
    const pos = new THREE.Vector3();
    pos.setFromMatrixPosition(controller.matrixWorld);
    robot.position.set(pos.x,pos.y,pos.z);
    scene.add(robot);

    // Place bed 1 meter ahead
    const bedPos = new THREE.Vector3();
    bedPos.copy(pos);
    bedPos.z -= 1.5;
    bed.position.copy(bedPos);
    scene.add(bed);

    placed = true;
  } else {
    // Check if bed was tapped
    const tempMatrix = new THREE.Matrix4();
    tempMatrix.identity().extractRotation(controller.matrixWorld);
    const pos = new THREE.Vector3();
    pos.setFromMatrixPosition(controller.matrixWorld);

    const distance = pos.distanceTo(bed.position);
    if(distance < 0.5){
      showConfetti();
    }
  }
}

function showConfetti(){
  const text = document.getElementById('confettiText');
  text.style.display = 'block';
  setTimeout(()=>{ text.style.display='none'; },3000);
}

function render(){
  renderer.render(scene, camera);
}

window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
